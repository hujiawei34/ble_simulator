{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>BLE设备模拟器</h1>
            <div>
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">返回首页</a>
            </div>
        </div>
    </div>
</div>

<!-- 状态卡片 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-broadcast"></i> 模拟器状态
                </h5>
                <button id="refresh-status" class="btn btn-sm btn-outline-primary">刷新状态</button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between">
                            <span>运行状态:</span>
                            <span id="running-status" class="badge {% if status and status.is_running %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if status and status.is_running %}运行中{% else %}已停止{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between">
                            <span>初始化状态:</span>
                            <span id="init-status" class="badge {% if status and status.is_initialized %}bg-success{% else %}bg-warning{% endif %}">
                                {% if status and status.is_initialized %}已初始化{% else %}未初始化{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between">
                            <span>已发送数据:</span>
                            <span id="data-sent-count" class="badge bg-info">
                                {% if status %}{{ status.data_sent_count }}{% else %}0{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex justify-content-between">
                            <span>连接客户端:</span>
                            <span id="connected-clients" class="badge bg-primary">
                                {% if status %}{{ status.connected_clients }}{% else %}0{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 控制面板 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> 控制面板
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>模拟器控制</h6>
                        <div class="d-grid gap-2 d-md-flex">
                            <form method="POST" action="{{ url_for('peripheral.start_simulator') }}" class="me-2">
                                <button type="submit" class="btn btn-success"
                                        {% if status and status.is_running %}disabled{% endif %}>
                                    <i class="bi bi-play-fill"></i> 启动模拟器
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('peripheral.stop_simulator') }}">
                                <button type="submit" class="btn btn-danger"
                                        {% if not status or not status.is_running %}disabled{% endif %}>
                                    <i class="bi bi-stop-fill"></i> 停止模拟器
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>模拟模式</h6>
                        <form method="POST" action="{{ url_for('peripheral.set_simulation_mode') }}" class="d-flex">
                            <select name="mode" class="form-select me-2">
                                <option value="normal">正常模式</option>
                                <option value="exercise">运动模式</option>
                                <option value="rest">休息模式</option>
                            </select>
                            <button type="submit" class="btn btn-primary">设置</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 当前数据 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> 当前握力数据
                </h5>
                <button id="refresh-data" class="btn btn-sm btn-outline-primary">刷新数据</button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label for="current-data">当前数据:</label>
                            <input type="text" id="current-data" class="form-control font-monospace"
                                   value="{{ current_data or 'L1:100 L2:100 L3:100 R1:100 R2:100 R3:100 Score:80' }}" readonly>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>&nbsp;</label>
                        <div class="d-grid">
                            <button id="auto-refresh" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i> 自动刷新: 关闭
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 手动设置数据 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil"></i> 手动设置握力数据
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('peripheral.set_grip_data') }}">
                    <div class="row">
                        <div class="col-md-10">
                            <label for="manual-data">数据格式: L1:值 L2:值 L3:值 R1:值 R2:值 R3:值 Score:值</label>
                            <input type="text" name="data" id="manual-data" class="form-control font-monospace"
                                   placeholder="L1:123 L2:111 L3:100 R1:145 R2:555 R3:120 Score:85" required>
                        </div>
                        <div class="col-md-2">
                            <label>&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-warning">设置数据</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 数据历史 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> 数据历史
                </h5>
                <button id="refresh-history" class="btn btn-sm btn-outline-primary">刷新历史</button>
            </div>
            <div class="card-body">
                <div id="history-container">
                    <div class="text-center text-muted">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 连接说明 -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> 使用说明</h6>
            <ul class="mb-0">
                <li><strong>启动模拟器</strong>：点击"启动模拟器"按钮，设备将开始BLE广播</li>
                <li><strong>手机连接</strong>：使用nRF Connect等BLE调试工具搜索"Support Frame Simulator"设备</li>
                <li><strong>服务UUID</strong>：12345678-1234-5678-9abc-123456789abc</li>
                <li><strong>握力数据特征值</strong>：12345678-1234-5678-9abc-123456789abd (可读取和订阅通知)</li>
                <li><strong>数据格式</strong>：L1:左1 L2:左2 L3:左3 R1:右1 R2:右2 R3:右3 Score:评分</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshInterval = null;
let isAutoRefresh = false;

// 刷新状态
async function refreshStatus() {
    try {
        const response = await fetch('/peripheral/api/status');
        const result = await response.json();

        if (result.success) {
            const status = result.data;

            // 更新状态显示
            document.getElementById('running-status').textContent = status.is_running ? '运行中' : '已停止';
            document.getElementById('running-status').className = `badge ${status.is_running ? 'bg-success' : 'bg-secondary'}`;

            document.getElementById('init-status').textContent = status.is_initialized ? '已初始化' : '未初始化';
            document.getElementById('init-status').className = `badge ${status.is_initialized ? 'bg-success' : 'bg-warning'}`;

            document.getElementById('data-sent-count').textContent = status.data_sent_count || 0;
            document.getElementById('connected-clients').textContent = status.connected_clients || 0;
        }
    } catch (error) {
        console.error('刷新状态失败:', error);
    }
}

// 刷新当前数据
async function refreshCurrentData() {
    try {
        const response = await fetch('/peripheral/api/data/current');
        const result = await response.json();

        if (result.success) {
            document.getElementById('current-data').value = result.data;
        }
    } catch (error) {
        console.error('刷新数据失败:', error);
    }
}

// 刷新历史数据
async function refreshHistory() {
    try {
        const response = await fetch('/peripheral/api/history?limit=20');
        const result = await response.json();

        if (result.success) {
            const historyContainer = document.getElementById('history-container');

            if (result.data.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-muted"><p>暂无历史数据</p></div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>时间</th><th>握力数据</th></tr></thead><tbody>';

            result.data.reverse().forEach(item => {
                const time = new Date(item.timestamp).toLocaleString();
                html += `<tr><td>${time}</td><td class="font-monospace">${item.data}</td></tr>`;
            });

            html += '</tbody></table></div>';
            historyContainer.innerHTML = html;
        }
    } catch (error) {
        console.error('刷新历史失败:', error);
        document.getElementById('history-container').innerHTML = '<div class="text-center text-danger"><p>加载失败</p></div>';
    }
}

// 切换自动刷新
function toggleAutoRefresh() {
    const button = document.getElementById('auto-refresh');

    if (isAutoRefresh) {
        // 停止自动刷新
        clearInterval(autoRefreshInterval);
        isAutoRefresh = false;
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 自动刷新: 关闭';
        button.className = 'btn btn-outline-secondary';
    } else {
        // 开始自动刷新
        autoRefreshInterval = setInterval(() => {
            refreshStatus();
            refreshCurrentData();
        }, 2000); // 每2秒刷新一次

        isAutoRefresh = true;
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 自动刷新: 开启';
        button.className = 'btn btn-outline-success';
    }
}

// 事件绑定
document.addEventListener('DOMContentLoaded', function() {
    // 绑定按钮事件
    document.getElementById('refresh-status').addEventListener('click', refreshStatus);
    document.getElementById('refresh-data').addEventListener('click', refreshCurrentData);
    document.getElementById('refresh-history').addEventListener('click', refreshHistory);
    document.getElementById('auto-refresh').addEventListener('click', toggleAutoRefresh);

    // 初始加载
    refreshStatus();
    refreshCurrentData();
    refreshHistory();
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}